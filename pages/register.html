<div class="auth-container">
    <div class="auth-card">
        <div class="auth-header">
            <h1>ERP AgroGoi√°s</h1>
            <p>Crie sua conta</p>
        </div>

        <form id="registerForm" onsubmit="handleRegister(event)" class="auth-form">
            <div class="form-group">
                <label for="registerName">Nome</label>
                <input 
                    type="text" 
                    id="registerName" 
                    name="name" 
                    required 
                    placeholder="Seu nome completo"
                    autocomplete="name"
                >
            </div>

            <div class="form-group">
                <label for="registerEmail">Email</label>
                <input 
                    type="email" 
                    id="registerEmail" 
                    name="email" 
                    required 
                    placeholder="seu@email.com"
                    autocomplete="email"
                >
            </div>

            <div class="form-group">
                <label for="registerPassword">Senha</label>
                <input 
                    type="password" 
                    id="registerPassword" 
                    name="password" 
                    required 
                    placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
                    autocomplete="new-password"
                    minlength="6"
                >
                <small class="form-help">M√≠nimo de 6 caracteres</small>
            </div>

            <div class="form-group">
                <label for="registerPasswordConfirm">Confirmar Senha</label>
                <input 
                    type="password" 
                    id="registerPasswordConfirm" 
                    name="passwordConfirm" 
                    required 
                    placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
                    autocomplete="new-password"
                >
            </div>

            <div class="form-actions">
                <button type="submit" class="btn-primary btn-block">Criar Conta</button>
            </div>

            <div class="auth-footer">
                <p>J√° tem uma conta? <a href="#" onclick="event.preventDefault(); if (typeof window.navigate === 'function') window.navigate('/login'); else window.location.href = '/login';">Fa√ßa login</a></p>
            </div>
        </form>

        <div id="registerError" class="error-message" style="display: none;"></div>
        <div id="registerSuccess" class="success-message" style="display: none;"></div>
    </div>
</div>

<script>
async function handleRegister(event) {
    event.preventDefault();
    
    const name = document.getElementById('registerName').value;
    const email = document.getElementById('registerEmail').value;
    const password = document.getElementById('registerPassword').value;
    const passwordConfirm = document.getElementById('registerPasswordConfirm').value;
    const errorDiv = document.getElementById('registerError');
    const successDiv = document.getElementById('registerSuccess');
    const submitButton = event.target.querySelector('button[type="submit"]');

    // Limpar mensagens anteriores
    errorDiv.style.display = 'none';
    errorDiv.textContent = '';
    successDiv.style.display = 'none';
    successDiv.textContent = '';

    // Validar senhas
    if (password !== passwordConfirm) {
        errorDiv.textContent = 'As senhas n√£o coincidem';
        errorDiv.style.display = 'block';
        return;
    }

    if (password.length < 6) {
        errorDiv.textContent = 'A senha deve ter no m√≠nimo 6 caracteres';
        errorDiv.style.display = 'block';
        return;
    }

    // Desabilitar bot√£o
    submitButton.disabled = true;
    submitButton.textContent = 'Criando conta...';

    try {
        // Aguardar fun√ß√£o signUp estar dispon√≠vel (exportada via globals.js)
        let retries = 0;
        while (typeof window.signUp !== 'function' && retries < 50) {
            await new Promise(resolve => setTimeout(resolve, 100));
            retries++;
        }

        if (typeof window.signUp !== 'function') {
            throw new Error('Sistema n√£o est√° pronto. Recarregue a p√°gina.');
        }

        const userData = {
            name: name,
            role: 'PRODUCER' // Role padr√£o
        };

        console.log('üìù Tentando criar conta para:', email);
        const { data, error } = await window.signUp(email, password, userData);

        if (error) {
            console.error('‚ùå Erro ao criar conta:', error);
            errorDiv.textContent = error.message || 'Erro ao criar conta';
            errorDiv.style.display = 'block';
            submitButton.disabled = false;
            submitButton.textContent = 'Criar Conta';
        } else {
            console.log('‚úÖ Conta criada com sucesso!', data);
            successDiv.textContent = 'Conta criada com sucesso! ' + (data?.user?.email_confirmed_at ? 'Voc√™ j√° pode fazer login.' : 'Verifique seu email para confirmar sua conta.');
            successDiv.style.display = 'block';
            // Limpar formul√°rio
            event.target.reset();
            // Redirecionar para login ap√≥s 3 segundos
            setTimeout(() => {
                if (typeof window.navigate === 'function') {
                    window.navigate('/login');
                } else {
                    window.location.href = '/login';
                }
            }, 3000);
        }
    } catch (error) {
        console.error('‚ùå Erro inesperado ao criar conta:', error);
        errorDiv.textContent = error.message || 'Erro ao criar conta. Tente novamente.';
        errorDiv.style.display = 'block';
        submitButton.disabled = false;
        submitButton.textContent = 'Criar Conta';
    }
}

// Verificar se j√° est√° autenticado (apenas uma vez)
let authCheckDone = false;

async function checkAuth() {
    // Evitar m√∫ltiplas verifica√ß√µes simult√¢neas
    if (authCheckDone) return;
    authCheckDone = true;
    
    try {
        // Aguardar fun√ß√£o isAuthenticated estar dispon√≠vel
        let retries = 0;
        while (typeof window.isAuthenticated !== 'function' && retries < 20) {
            await new Promise(resolve => setTimeout(resolve, 100));
            retries++;
        }
        
        if (typeof window.isAuthenticated === 'function') {
            const authenticated = await window.isAuthenticated();
            if (authenticated) {
                // Usar window.location para evitar loop no router
                window.location.href = '/dashboard';
            }
        }
    } catch (error) {
        console.error('Erro ao verificar autentica√ß√£o:', error);
        authCheckDone = false; // Permitir nova tentativa em caso de erro
    }
}

// Executar quando p√°gina carregar (apenas uma vez)
let pageLoadedHandler = null;
if (!pageLoadedHandler) {
    pageLoadedHandler = () => {
        if (window.location.pathname === '/register' && !authCheckDone) {
            setTimeout(checkAuth, 100);
        }
    };
    window.addEventListener('pageLoaded', pageLoadedHandler);
}

// Executar na primeira vez (apenas se ainda n√£o foi executado)
if ((window.location.pathname === '/register' || document.getElementById('registerForm')) && !authCheckDone) {
    setTimeout(checkAuth, 500);
}
</script>

