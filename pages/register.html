<div class="auth-container">
    <div class="auth-card">
        <div class="auth-header">
            <h1>ERP AgroGoiás</h1>
            <p>Crie sua conta</p>
        </div>

        <form id="registerForm" onsubmit="handleRegister(event)" class="auth-form">
            <div class="form-group">
                <label for="registerName">Nome</label>
                <input 
                    type="text" 
                    id="registerName" 
                    name="name" 
                    required 
                    placeholder="Seu nome completo"
                    autocomplete="name"
                >
            </div>

            <div class="form-group">
                <label for="registerEmail">Email</label>
                <input 
                    type="email" 
                    id="registerEmail" 
                    name="email" 
                    required 
                    placeholder="seu@email.com"
                    autocomplete="email"
                >
            </div>

            <div class="form-group">
                <label for="registerPassword">Senha</label>
                <input 
                    type="password" 
                    id="registerPassword" 
                    name="password" 
                    required 
                    placeholder="••••••••"
                    autocomplete="new-password"
                    minlength="6"
                >
                <small class="form-help">Mínimo de 6 caracteres</small>
            </div>

            <div class="form-group">
                <label for="registerPasswordConfirm">Confirmar Senha</label>
                <input 
                    type="password" 
                    id="registerPasswordConfirm" 
                    name="passwordConfirm" 
                    required 
                    placeholder="••••••••"
                    autocomplete="new-password"
                >
            </div>

            <div class="form-actions">
                <button type="submit" class="btn-primary btn-block">Criar Conta</button>
            </div>

            <div class="auth-footer">
                <p>Já tem uma conta? <a href="#" onclick="event.preventDefault(); navigate('/login')">Faça login</a></p>
            </div>
        </form>

        <div id="registerError" class="error-message" style="display: none;"></div>
        <div id="registerSuccess" class="success-message" style="display: none;"></div>
    </div>
</div>

<script>
async function handleRegister(event) {
    event.preventDefault();
    
    const name = document.getElementById('registerName').value;
    const email = document.getElementById('registerEmail').value;
    const password = document.getElementById('registerPassword').value;
    const passwordConfirm = document.getElementById('registerPasswordConfirm').value;
    const errorDiv = document.getElementById('registerError');
    const successDiv = document.getElementById('registerSuccess');
    const submitButton = event.target.querySelector('button[type="submit"]');

    // Limpar mensagens anteriores
    errorDiv.style.display = 'none';
    errorDiv.textContent = '';
    successDiv.style.display = 'none';
    successDiv.textContent = '';

    // Validar senhas
    if (password !== passwordConfirm) {
        errorDiv.textContent = 'As senhas não coincidem';
        errorDiv.style.display = 'block';
        return;
    }

    if (password.length < 6) {
        errorDiv.textContent = 'A senha deve ter no mínimo 6 caracteres';
        errorDiv.style.display = 'block';
        return;
    }

    // Desabilitar botão
    submitButton.disabled = true;
    submitButton.textContent = 'Criando conta...';

    try {
        // Aguardar Supabase e funções de auth carregarem
        let retries = 0;
        while ((!window.supabaseClient || typeof signUp !== 'function') && retries < 50) {
            await new Promise(resolve => setTimeout(resolve, 100));
            retries++;
        }

        if (!window.supabaseClient || typeof signUp !== 'function') {
            throw new Error('Sistema não está pronto. Recarregue a página.');
        }

        const userData = {
            name: name,
            role: 'PRODUCER' // Role padrão
        };

        const { data, error } = await signUp(email, password, userData);

        if (error) {
            errorDiv.textContent = error.message;
            errorDiv.style.display = 'block';
            submitButton.disabled = false;
            submitButton.textContent = 'Criar Conta';
        } else {
            successDiv.textContent = 'Conta criada com sucesso! Verifique seu email para confirmar.';
            successDiv.style.display = 'block';
            // Limpar formulário
            event.target.reset();
            // Redirecionar para login após 3 segundos
            setTimeout(() => {
                if (typeof navigate === 'function') {
                    navigate('/login');
                } else {
                    window.location.href = '/login';
                }
            }, 3000);
        }
    } catch (error) {
        console.error('Erro ao criar conta:', error);
        errorDiv.textContent = error.message || 'Erro ao criar conta';
        errorDiv.style.display = 'block';
        submitButton.disabled = false;
        submitButton.textContent = 'Criar Conta';
    }
}

// Verificar se já está autenticado (apenas uma vez)
let authCheckDone = false;

async function checkAuth() {
    // Evitar múltiplas verificações simultâneas
    if (authCheckDone) return;
    authCheckDone = true;
    
    try {
        // Aguardar funções de auth estarem disponíveis
        let retries = 0;
        while (typeof isAuthenticated !== 'function' && retries < 20) {
            await new Promise(resolve => setTimeout(resolve, 100));
            retries++;
        }
        
        if (typeof isAuthenticated === 'function') {
            const authenticated = await isAuthenticated();
            if (authenticated) {
                // Usar window.location para evitar loop no router
                window.location.href = '/dashboard';
            }
        }
    } catch (error) {
        console.error('Erro ao verificar autenticação:', error);
        authCheckDone = false; // Permitir nova tentativa em caso de erro
    }
}

// Executar quando página carregar (apenas uma vez)
let pageLoadedHandler = null;
if (!pageLoadedHandler) {
    pageLoadedHandler = () => {
        if (window.location.pathname === '/register' && !authCheckDone) {
            setTimeout(checkAuth, 100);
        }
    };
    window.addEventListener('pageLoaded', pageLoadedHandler);
}

// Executar na primeira vez (apenas se ainda não foi executado)
if ((window.location.pathname === '/register' || document.getElementById('registerForm')) && !authCheckDone) {
    setTimeout(checkAuth, 500);
}
</script>

