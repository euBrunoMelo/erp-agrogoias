<div class="page-container">
    <div class="page-header">
        <h1>Produtos</h1>
        <button onclick="showProductForm()" class="btn-primary">+ Novo Produto</button>
    </div>

    <div id="productsList" class="products-list">
        <p>Carregando...</p>
    </div>

    <!-- Modal de Formulário -->
    <div id="productModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">Novo Produto</h2>
                <button onclick="closeProductForm()" class="close-btn">&times;</button>
            </div>
            <form id="productForm" onsubmit="saveProduct(event)">
                <input type="hidden" id="productId">
                
                <div class="form-group">
                    <label for="productName">Nome *</label>
                    <input type="text" id="productName" required>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="productBrand">Marca</label>
                        <input type="text" id="productBrand">
                    </div>
                    <div class="form-group">
                        <label for="productType">Tipo *</label>
                        <select id="productType" required>
                            <option value="">Selecione...</option>
                            <option value="SEED">Semente</option>
                            <option value="FERTILIZER">Fertilizante</option>
                            <option value="PESTICIDE">Defensivo</option>
                            <option value="FUEL">Combustível</option>
                            <option value="MACHINERY_PARTS">Peças</option>
                            <option value="OTHER">Outro</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="productCategory">Categoria</label>
                    <input type="text" id="productCategory" placeholder="Ex: Herbicida, Inseticida, etc.">
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="productUnit">Unidade *</label>
                        <select id="productUnit" required>
                            <option value="kg">kg</option>
                            <option value="L">Litro (L)</option>
                            <option value="un">Unidade</option>
                            <option value="saco">Saco</option>
                            <option value="ton">Tonelada</option>
                            <option value="m3">m³</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="productPrice">Preço Atual (R$)</label>
                        <input type="number" id="productPrice" step="0.01" min="0">
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="productActiveIngredient">Ingrediente Ativo</label>
                    <input type="text" id="productActiveIngredient" placeholder="Para defensivos">
                </div>
                
                <div class="form-group">
                    <label for="productDosage">Dosagem Recomendada</label>
                    <input type="text" id="productDosage" placeholder="Ex: 2L/ha">
                </div>
                
                <div class="form-group">
                    <label for="productSupplier">Fornecedor</label>
                    <input type="text" id="productSupplier">
                </div>
                
                <div class="form-group">
                    <label for="productDescription">Descrição</label>
                    <textarea id="productDescription" rows="3"></textarea>
                </div>
                
                <div class="form-actions">
                    <button type="button" onclick="closeProductForm()" class="btn-secondary">Cancelar</button>
                    <button type="submit" class="btn-primary">Salvar</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
let editingProductId = null;

async function loadProducts() {
    const list = document.getElementById('productsList');
    list.innerHTML = '<p>Carregando...</p>';
    
    try {
        const products = await getProducts();
        
        if (products.length === 0) {
            list.innerHTML = '<p class="empty-state">Nenhum produto cadastrado. Clique em "Novo Produto" para começar.</p>';
            return;
        }
        
        const typeLabels = {
            'SEED': 'Semente',
            'FERTILIZER': 'Fertilizante',
            'PESTICIDE': 'Defensivo',
            'FUEL': 'Combustível',
            'MACHINERY_PARTS': 'Peças',
            'OTHER': 'Outro'
        };
        
        list.innerHTML = products.map(product => `
            <div class="property-card">
                <div class="property-info">
                    <h3>${product.name}</h3>
                    <p><strong>Tipo:</strong> ${typeLabels[product.type] || product.type}</p>
                    ${product.brand ? `<p><strong>Marca:</strong> ${product.brand}</p>` : ''}
                    ${product.category ? `<p><strong>Categoria:</strong> ${product.category}</p>` : ''}
                    <p><strong>Unidade:</strong> ${product.unit}</p>
                    ${product.current_price ? `<p><strong>Preço:</strong> R$ ${parseFloat(product.current_price).toFixed(2)}</p>` : ''}
                    ${product.supplier ? `<p><strong>Fornecedor:</strong> ${product.supplier}</p>` : ''}
                </div>
                <div class="property-actions">
                    <button onclick="editProduct('${product.id}')" class="btn-edit">Editar</button>
                    <button onclick="deleteProductConfirm('${product.id}')" class="btn-delete">Excluir</button>
                </div>
            </div>
        `).join('');
    } catch (error) {
        list.innerHTML = '<p class="error">Erro ao carregar produtos</p>';
    }
}

function showProductForm(productId = null) {
    editingProductId = productId;
    const modal = document.getElementById('productModal');
    const form = document.getElementById('productForm');
    const title = document.getElementById('modalTitle');
    
    if (productId) {
        title.textContent = 'Editar Produto';
        loadProductForEdit(productId);
    } else {
        title.textContent = 'Novo Produto';
        form.reset();
        document.getElementById('productId').value = '';
    }
    
    modal.classList.add('show');
}

function closeProductForm() {
    document.getElementById('productModal').classList.remove('show');
    editingProductId = null;
}

async function loadProductForEdit(id) {
    try {
        const product = await getProductById(id);
        if (product) {
            document.getElementById('productId').value = product.id;
            document.getElementById('productName').value = product.name || '';
            document.getElementById('productBrand').value = product.brand || '';
            document.getElementById('productType').value = product.type || '';
            document.getElementById('productCategory').value = product.category || '';
            document.getElementById('productUnit').value = product.unit || 'kg';
            document.getElementById('productPrice').value = product.current_price || '';
            document.getElementById('productActiveIngredient').value = product.active_ingredient || '';
            document.getElementById('productDosage').value = product.dosage || '';
            document.getElementById('productSupplier').value = product.supplier || '';
            document.getElementById('productDescription').value = product.description || '';
        }
    } catch (error) {
        console.error('Erro ao carregar produto:', error);
    }
}

async function saveProduct(event) {
    event.preventDefault();
    
    const id = document.getElementById('productId').value;
    
    const product = {
        name: document.getElementById('productName').value,
        brand: document.getElementById('productBrand').value || null,
        type: document.getElementById('productType').value,
        category: document.getElementById('productCategory').value || null,
        unit: document.getElementById('productUnit').value,
        current_price: parseFloat(document.getElementById('productPrice').value) || null,
        active_ingredient: document.getElementById('productActiveIngredient').value || null,
        dosage: document.getElementById('productDosage').value || null,
        supplier: document.getElementById('productSupplier').value || null,
        description: document.getElementById('productDescription').value || null
    };
    
    try {
        if (id) {
            await updateProduct(id, product);
        } else {
            await createProduct(product);
        }
        closeProductForm();
        loadProducts();
    } catch (error) {
        console.error('Erro ao salvar produto:', error);
    }
}

async function editProduct(id) {
    showProductForm(id);
}

async function deleteProductConfirm(id) {
    if (confirm('Tem certeza que deseja excluir este produto? Esta ação não pode ser desfeita.')) {
        try {
            await deleteProduct(id);
            loadProducts();
        } catch (error) {
            console.error('Erro ao excluir produto:', error);
        }
    }
}

// Aguardar Supabase carregar antes de executar
async function initProductsPage() {
    const authenticated = await requireAuth();
    if (!authenticated) {
        return;
    }

    while (!window.supabaseClient) {
        await new Promise(resolve => setTimeout(resolve, 100));
    }
    supabase = window.supabaseClient;
    loadProducts();
}

// Carregar produtos ao carregar a página
window.addEventListener('pageLoaded', () => {
    if (window.location.pathname === '/products') {
        setTimeout(initProductsPage, 100);
    }
});

// Carregar na primeira vez
if (window.location.pathname === '/products' || document.getElementById('productsList')) {
    setTimeout(initProductsPage, 500);
}
</script>

