<div class="page-container">
    <div class="page-header">
        <h1>Análises de Solo</h1>
        <button onclick="showSoilAnalysisForm()" class="btn-primary">+ Nova Análise</button>
    </div>

    <div class="filters">
        <label for="plotFilter">Filtrar por Talhão:</label>
        <select id="plotFilter" onchange="loadSoilAnalyses()">
            <option value="">Todos os talhões</option>
        </select>
    </div>

    <div id="soilAnalysesList" class="properties-list">
        <p>Carregando...</p>
    </div>

    <!-- Modal de Formulário -->
    <div id="soilAnalysisModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">Nova Análise de Solo</h2>
                <button onclick="closeSoilAnalysisForm()" class="close-btn">&times;</button>
            </div>
            <form id="soilAnalysisForm" onsubmit="saveSoilAnalysis(event)">
                <input type="hidden" id="soilAnalysisId">
                
                <div class="form-group">
                    <label for="plotId">Talhão *</label>
                    <select id="plotId" required>
                        <option value="">Selecione um talhão</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="analysisDate">Data da Análise *</label>
                    <input type="date" id="analysisDate" required>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="ph">pH</label>
                        <input type="number" id="ph" step="0.01" min="0" max="14" placeholder="Ex: 6.5">
                    </div>
                    <div class="form-group">
                        <label for="organicMatter">Matéria Orgânica (%)</label>
                        <input type="number" id="organicMatter" step="0.01" min="0" placeholder="Ex: 3.5">
                    </div>
                </div>
                
                <div class="form-group">
                    <label>Macronutrientes</label>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="nitrogen">Nitrogênio (mg/dm³)</label>
                            <input type="number" id="nitrogen" step="0.01" min="0" placeholder="Ex: 25.5">
                        </div>
                        <div class="form-group">
                            <label for="phosphorus">Fósforo (mg/dm³)</label>
                            <input type="number" id="phosphorus" step="0.01" min="0" placeholder="Ex: 12.3">
                        </div>
                        <div class="form-group">
                            <label for="potassium">Potássio (mg/dm³)</label>
                            <input type="number" id="potassium" step="0.01" min="0" placeholder="Ex: 150.0">
                        </div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="texture">Textura do Solo</label>
                    <select id="texture">
                        <option value="">Selecione</option>
                        <option value="Arenoso">Arenoso</option>
                        <option value="Argiloso">Argiloso</option>
                        <option value="Franco">Franco</option>
                        <option value="Franco-argiloso">Franco-argiloso</option>
                        <option value="Franco-arenoso">Franco-arenoso</option>
                    </select>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="laboratory">Laboratório</label>
                        <input type="text" id="laboratory" placeholder="Nome do laboratório">
                    </div>
                    <div class="form-group">
                        <label for="reportNumber">Número do Relatório</label>
                        <input type="text" id="reportNumber" placeholder="Ex: REL-2024-001">
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="recommendations">Recomendações</label>
                    <textarea id="recommendations" rows="4" placeholder="Recomendações baseadas na análise..."></textarea>
                </div>
                
                <div class="form-actions">
                    <button type="button" onclick="closeSoilAnalysisForm()" class="btn-secondary">Cancelar</button>
                    <button type="submit" class="btn-primary">Salvar</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
let editingSoilAnalysisId = null;

async function loadPlots() {
    try {
        const plots = await getPlots();
        const plotSelect = document.getElementById('plotId');
        const filterSelect = document.getElementById('plotFilter');
        
        // Limpar opções existentes (exceto a primeira)
        plotSelect.innerHTML = '<option value="">Selecione um talhão</option>';
        filterSelect.innerHTML = '<option value="">Todos os talhões</option>';
        
        plots.forEach(plot => {
            const option = document.createElement('option');
            option.value = plot.id;
            option.textContent = `${plot.name} - ${plot.properties?.name || 'Sem propriedade'}`;
            plotSelect.appendChild(option);
            
            const filterOption = document.createElement('option');
            filterOption.value = plot.id;
            filterOption.textContent = `${plot.name} - ${plot.properties?.name || 'Sem propriedade'}`;
            filterSelect.appendChild(filterOption);
        });
    } catch (error) {
        console.error('Erro ao carregar talhões:', error);
    }
}

async function loadSoilAnalyses() {
    const list = document.getElementById('soilAnalysesList');
    list.innerHTML = '<p>Carregando...</p>';
    
    try {
        const plotId = document.getElementById('plotFilter')?.value || null;
        const analyses = await getSoilAnalyses(plotId);
        
        if (analyses.length === 0) {
            list.innerHTML = '<p class="empty-state">Nenhuma análise de solo cadastrada. Clique em "Nova Análise" para começar.</p>';
            return;
        }
        
        list.innerHTML = analyses.map(analysis => {
            const plotName = analysis.plots?.name || 'Talhão desconhecido';
            const propertyName = analysis.plots?.properties?.name || '';
            const date = new Date(analysis.analysis_date).toLocaleDateString('pt-BR');
            
            return `
                <div class="property-card">
                    <div class="property-info">
                        <h3>${plotName} ${propertyName ? `- ${propertyName}` : ''}</h3>
                        <p><strong>Data:</strong> ${date}</p>
                        ${analysis.ph ? `<p><strong>pH:</strong> ${analysis.ph}</p>` : ''}
                        ${analysis.organic_matter ? `<p><strong>Matéria Orgânica:</strong> ${analysis.organic_matter}%</p>` : ''}
                        ${analysis.nitrogen || analysis.phosphorus || analysis.potassium ? `
                            <p><strong>Macronutrientes:</strong> 
                                ${analysis.nitrogen ? `N: ${analysis.nitrogen}` : ''}
                                ${analysis.phosphorus ? ` | P: ${analysis.phosphorus}` : ''}
                                ${analysis.potassium ? ` | K: ${analysis.potassium}` : ''}
                            </p>
                        ` : ''}
                        ${analysis.texture ? `<p><strong>Textura:</strong> ${analysis.texture}</p>` : ''}
                        ${analysis.laboratory ? `<p><strong>Laboratório:</strong> ${analysis.laboratory}</p>` : ''}
                    </div>
                    <div class="property-actions">
                        <button onclick="editSoilAnalysis('${analysis.id}')" class="btn-edit">Editar</button>
                        <button onclick="deleteSoilAnalysisConfirm('${analysis.id}')" class="btn-delete">Excluir</button>
                    </div>
                </div>
            `;
        }).join('');
    } catch (error) {
        list.innerHTML = '<p class="error">Erro ao carregar análises de solo</p>';
    }
}

function showSoilAnalysisForm(analysisId = null) {
    editingSoilAnalysisId = analysisId;
    const modal = document.getElementById('soilAnalysisModal');
    const form = document.getElementById('soilAnalysisForm');
    const title = document.getElementById('modalTitle');
    
    if (analysisId) {
        title.textContent = 'Editar Análise de Solo';
        loadSoilAnalysisForEdit(analysisId);
    } else {
        title.textContent = 'Nova Análise de Solo';
        form.reset();
        document.getElementById('soilAnalysisId').value = '';
        // Definir data padrão como hoje
        document.getElementById('analysisDate').value = new Date().toISOString().split('T')[0];
    }
    
    modal.classList.add('show');
}

function closeSoilAnalysisForm() {
    document.getElementById('soilAnalysisModal').classList.remove('show');
    editingSoilAnalysisId = null;
}

async function loadSoilAnalysisForEdit(id) {
    try {
        const analysis = await getSoilAnalysisById(id);
        if (analysis) {
            document.getElementById('soilAnalysisId').value = analysis.id;
            document.getElementById('plotId').value = analysis.plot_id || '';
            document.getElementById('analysisDate').value = analysis.analysis_date || '';
            document.getElementById('ph').value = analysis.ph || '';
            document.getElementById('organicMatter').value = analysis.organic_matter || '';
            document.getElementById('nitrogen').value = analysis.nitrogen || '';
            document.getElementById('phosphorus').value = analysis.phosphorus || '';
            document.getElementById('potassium').value = analysis.potassium || '';
            document.getElementById('texture').value = analysis.texture || '';
            document.getElementById('laboratory').value = analysis.laboratory || '';
            document.getElementById('reportNumber').value = analysis.report_number || '';
            document.getElementById('recommendations').value = analysis.recommendations || '';
        }
    } catch (error) {
        console.error('Erro ao carregar análise de solo:', error);
    }
}

async function saveSoilAnalysis(event) {
    event.preventDefault();
    
    const id = document.getElementById('soilAnalysisId').value;
    const analysis = {
        plot_id: document.getElementById('plotId').value,
        analysis_date: document.getElementById('analysisDate').value,
        ph: document.getElementById('ph').value ? parseFloat(document.getElementById('ph').value) : null,
        organic_matter: document.getElementById('organicMatter').value ? parseFloat(document.getElementById('organicMatter').value) : null,
        nitrogen: document.getElementById('nitrogen').value ? parseFloat(document.getElementById('nitrogen').value) : null,
        phosphorus: document.getElementById('phosphorus').value ? parseFloat(document.getElementById('phosphorus').value) : null,
        potassium: document.getElementById('potassium').value ? parseFloat(document.getElementById('potassium').value) : null,
        texture: document.getElementById('texture').value || null,
        laboratory: document.getElementById('laboratory').value || null,
        report_number: document.getElementById('reportNumber').value || null,
        recommendations: document.getElementById('recommendations').value || null
    };
    
    try {
        if (id) {
            await updateSoilAnalysis(id, analysis);
        } else {
            await createSoilAnalysis(analysis);
        }
        closeSoilAnalysisForm();
        loadSoilAnalyses();
    } catch (error) {
        console.error('Erro ao salvar análise de solo:', error);
    }
}

async function editSoilAnalysis(id) {
    showSoilAnalysisForm(id);
}

async function deleteSoilAnalysisConfirm(id) {
    if (confirm('Tem certeza que deseja excluir esta análise de solo? Esta ação não pode ser desfeita.')) {
        try {
            await deleteSoilAnalysis(id);
            loadSoilAnalyses();
        } catch (error) {
            console.error('Erro ao excluir análise de solo:', error);
        }
    }
}

// Aguardar Supabase carregar antes de executar
async function initSoilAnalysisPage() {
    // Verificar autenticação
    const authenticated = await requireAuth();
    if (!authenticated) {
        return;
    }

    await loadPlots();
    loadSoilAnalyses();
}

// Carregar análises ao carregar a página
window.addEventListener('pageLoaded', () => {
    if (window.location.pathname === '/soil-analysis') {
        setTimeout(initSoilAnalysisPage, 100);
    }
});

// Carregar na primeira vez
if (window.location.pathname === '/soil-analysis' || document.getElementById('soilAnalysesList')) {
    setTimeout(initSoilAnalysisPage, 500);
}
</script>

